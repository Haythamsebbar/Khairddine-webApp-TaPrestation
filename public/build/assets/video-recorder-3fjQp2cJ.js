function B(b,u){var a,o,n;for(o=document.getElementsByClassName("tab-content"),a=0;a<o.length;a++)o[a].style.display="none";for(n=document.getElementsByClassName("tab"),a=0;a<n.length;a++)n[a].className=n[a].className.replace(" active","");document.getElementById(u).style.display="block",b.currentTarget.className+=" active",sessionStorage.setItem("activeTab",u)}document.addEventListener("DOMContentLoaded",function(){const b=sessionStorage.getItem("activeTab")||"record-video",u=document.querySelector(`.tab[onclick*="'${b}'"]`);u&&u.click();const a=document.getElementById("drop-area"),o=document.getElementById("video"),n=document.getElementById("file-name");a&&(a.addEventListener("click",r=>{r.stopPropagation(),o.click()}),a.addEventListener("dragover",r=>{r.preventDefault(),a.style.borderColor="#5a67d8"}),a.addEventListener("dragleave",()=>{a.style.borderColor="#dee2e6"}),a.addEventListener("drop",r=>{r.preventDefault(),a.style.borderColor="#dee2e6";const t=r.dataTransfer.files;t.length>0&&(o.files=t,D({target:{files:t}}))})),o&&o.addEventListener("change",D);function D(r){const t=r.target.files[0],e=document.getElementById("video-preview");if(t){n.textContent=t.name;const s=URL.createObjectURL(t);e.src=s,e.style.display="block",e.onloadedmetadata=function(){e.duration>60&&(alert("La vidéo ne doit pas dépasser 60 secondes."),o.value="",e.style.display="none",n.textContent="")}}}const y=document.getElementById("start-record-btn"),m=document.getElementById("stop-record-btn"),v=document.getElementById("use-video-btn"),E=document.getElementById("live-video"),I=document.getElementById("recorded-video-preview"),p=document.getElementById("recording-timer"),S=document.getElementById("recorded_video_data");let c,h=[],k,f=0,g=null;async function C(){const r={browserSupport:!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia,isSecureContext:window.isSecureContext,protocol:window.location.protocol,userAgent:navigator.userAgent,devices:[],videoDevices:[],cameraAccessTest:null,permissionStatus:null};try{if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){const t=await navigator.mediaDevices.enumerateDevices();r.devices=t,r.videoDevices=t.filter(e=>e.kind==="videoinput")}}catch(t){console.error("Erreur lors du diagnostic:",t)}try{if(navigator.permissions){const t=await navigator.permissions.query({name:"camera"});r.permissionStatus=t.state}}catch(t){console.warn("Impossible de vérifier les permissions:",t)}try{const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});r.cameraAccessTest="success",t.getTracks().forEach(e=>e.stop())}catch(t){r.cameraAccessTest=t.name||t.message}return console.log("Diagnostic des caméras:",r),r}if(y){y.addEventListener("click",async()=>{const t=document.getElementById("camera-permission-error");t.style.display="none";try{const e=await C();if(!e.browserSupport)throw new Error("MediaDevices API not supported");if(e.videoDevices.length===0)throw new Error("NoVideoDevicesFound");let s;try{s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0})}catch(i){console.warn("Impossible d'accéder au microphone, essai avec vidéo seulement:",i);try{s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}catch(d){throw console.error("Impossible d'accéder à la caméra:",d),d}}E.srcObject=s,c=new MediaRecorder(s,{mimeType:"video/webm"}),c.ondataavailable=i=>{i.data.size>0&&h.push(i.data)},c.onstart=()=>{g=null,h=[],y.disabled=!0,m.disabled=!1,p.style.display="block",f=0,p.textContent="0s",k=setInterval(()=>{f++,p.textContent=`${f}s`,f>=60&&m.click()},1e3)},c.onstop=()=>{clearInterval(k),p.style.display="none",g=new Blob(h,{type:"video/webm"});const i=URL.createObjectURL(g);I.src=i,I.style.display="block",v.style.display="block",E.style.display="none",E.srcObject.getTracks().forEach(d=>d.stop())},c.start()}catch(e){console.error("Erreur d'accès à la caméra: ",e);let s="<strong>Erreur d'accès à la caméra.</strong> ",i="";switch(e.name||e.message){case"NotFoundError":case"NoVideoDevicesFound":s+="Aucune caméra n'a été trouvée sur votre appareil.",i=`
                            <div class="mt-3">
                                <strong>Solutions possibles :</strong>
                                <ul class="mt-2">
                                    <li>Vérifiez qu'une caméra est bien connectée à votre ordinateur</li>
                                    <li>Si vous utilisez une caméra externe, assurez-vous qu'elle est branchée et allumée</li>
                                    <li>Redémarrez votre navigateur et réessayez</li>
                                    <li>Vérifiez les pilotes de votre caméra dans le gestionnaire de périphériques</li>
                                    <li>Essayez avec un autre navigateur (Chrome, Firefox, Safari)</li>
                                </ul>
                            </div>`;break;case"NotAllowedError":s+="L'accès à la caméra a été refusé. Veuillez l'autoriser dans les paramètres de votre navigateur.",i=`
                            <div class="mt-3">
                                <strong>Comment autoriser la caméra :</strong>
                                <ul class="mt-2">
                                    <li>Cliquez sur l'icône de caméra dans la barre d'adresse</li>
                                    <li>Sélectionnez "Autoriser" pour ce site</li>
                                    <li>Rechargez la page et réessayez</li>
                                    <li>Dans Chrome : Paramètres > Confidentialité et sécurité > Paramètres du site > Caméra</li>
                                </ul>
                            </div>`;break;case"NotReadableError":s+="Un problème matériel empêche l'accès à la caméra. Assurez-vous qu'elle n'est pas utilisée par une autre application.",i=`
                            <div class="mt-3">
                                <strong>Solutions possibles :</strong>
                                <ul class="mt-2">
                                    <li>Fermez toutes les autres applications utilisant la caméra (Zoom, Skype, etc.)</li>
                                    <li>Redémarrez votre ordinateur</li>
                                    <li>Vérifiez que la caméra fonctionne dans d'autres applications</li>
                                </ul>
                            </div>`;break;case"MediaDevices API not supported":s+="Votre navigateur ne supporte pas l'accès à la caméra.",i=`
                            <div class="mt-3">
                                <strong>Solutions possibles :</strong>
                                <ul class="mt-2">
                                    <li>Mettez à jour votre navigateur vers la dernière version</li>
                                    <li>Utilisez un navigateur moderne (Chrome, Firefox, Safari, Edge)</li>
                                    <li>Vérifiez que JavaScript est activé</li>
                                </ul>
                            </div>`;break;default:s+="Une erreur inattendue est survenue. Veuillez réessayer.",i=`
                            <div class="mt-3">
                                <strong>Solutions générales :</strong>
                                <ul class="mt-2">
                                    <li>Rechargez la page et réessayez</li>
                                    <li>Redémarrez votre navigateur</li>
                                    <li>Essayez avec un autre navigateur</li>
                                    <li>Vérifiez votre connexion internet</li>
                                </ul>
                            </div>`}t.innerHTML=s+i,t.className="camera-error",t.style.display="block"}});const r=document.getElementById("diagnoseCameras");r&&r.addEventListener("click",async()=>{const t=document.getElementById("camera-permission-error"),e=await C();let s="<strong>Diagnostic des caméras :</strong><br>";if(s+=`<br><strong>Support du navigateur :</strong> ${e.browserSupport?"✅ Supporté":"❌ Non supporté"}`,s+=`<br><strong>Connexion sécurisée :</strong> ${e.isSecureContext?"✅ HTTPS":"⚠️ HTTP"} (${e.protocol})`,e.permissionStatus){const l=e.permissionStatus==="granted"?"✅":e.permissionStatus==="denied"?"❌":"⚠️";s+=`<br><strong>Permission caméra :</strong> ${l} ${e.permissionStatus}`}if(e.cameraAccessTest){const l=e.cameraAccessTest==="success"?"✅":"❌",w=e.cameraAccessTest==="success"?"Accès réussi":e.cameraAccessTest;s+=`<br><strong>Test d'accès :</strong> ${l} ${w}`}const i=e.userAgent.includes("Chrome")?"Chrome":e.userAgent.includes("Firefox")?"Firefox":e.userAgent.includes("Safari")?"Safari":e.userAgent.includes("Edge")?"Edge":"Autre";s+=`<br><strong>Navigateur :</strong> ${i}`,s+=`<br><strong>Caméras détectées :</strong> ${e.videoDevices.length}`,e.videoDevices.length>0?(s+='<ul class="mt-2">',e.videoDevices.forEach((l,w)=>{const L=l.label||`Caméra ${w+1}`;s+=`<li>${L} (ID: ${l.deviceId.substring(0,8)}...)</li>`}),s+="</ul>"):s+='<br><span style="color: #d32f2f;">❌ Aucune caméra détectée</span>';const d=e.devices.filter(l=>l.kind==="audioinput");s+=`<br><strong>Microphones détectés :</strong> ${d.length}`,e.browserSupport?e.videoDevices.length===0?s+=`<br><br><strong style="color: #d32f2f;">⚠️ Aucune caméra n'a été détectée sur votre système.</strong>`:s+=`<br><br><strong style="color: #2e7d32;">✅ Votre système semble compatible avec l'enregistrement vidéo.</strong>`:s+=`<br><br><strong style="color: #d32f2f;">⚠️ Votre navigateur ne supporte pas l'accès aux caméras.</strong>`,t.innerHTML=s,t.className="camera-error diagnostic",t.style.display="block"})}m&&m.addEventListener("click",()=>{c&&c.state==="recording"&&c.stop(),m.disabled=!0}),v&&v.addEventListener("click",()=>{if(g){const r=new FileReader;r.onloadend=function(){const t=r.result;S.value=t,alert("La vidéo enregistrée a été ajoutée au formulaire."),v.disabled=!0,v.innerHTML='<i class="fas fa-check"></i> Vidéo ajoutée',o.value="";const e=document.getElementById("video-preview");e.src="",e.style.display="none",n.textContent=""},r.readAsDataURL(g)}});const T=document.querySelector("#record-video form");T&&T.addEventListener("submit",function(r){if(!(S.value.trim()!=="")){alert("Veuillez enregistrer une vidéo avant de soumettre."),r.preventDefault();return}const e=r.submitter;e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Envoi en cours...')});const z=document.querySelector("#upload-video form");z&&z.addEventListener("submit",function(r){if(!(o.files.length>0)){alert("Veuillez sélectionner une vidéo à importer."),r.preventDefault();return}const e=r.submitter;e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Envoi en cours...')})});window.openTab=B;
