function V(y,m){var a,o,n;for(o=document.getElementsByClassName("tab-content"),a=0;a<o.length;a++)o[a].style.display="none";for(n=document.getElementsByClassName("tab"),a=0;a<n.length;a++)n[a].className=n[a].className.replace(" active","");document.getElementById(m).style.display="block",y.currentTarget.className+=" active",sessionStorage.setItem("activeTab",m)}document.addEventListener("DOMContentLoaded",function(){const y=sessionStorage.getItem("activeTab")||"record-video",m=document.querySelector(`.tab[onclick*="'${y}'"]`);m&&m.click();const a=document.getElementById("drop-area"),o=document.getElementById("video"),n=document.getElementById("file-name");a&&(a.addEventListener("click",r=>{r.stopPropagation(),o.click()}),a.addEventListener("dragover",r=>{r.preventDefault(),a.style.borderColor="#5a67d8"}),a.addEventListener("dragleave",()=>{a.style.borderColor="#dee2e6"}),a.addEventListener("drop",r=>{r.preventDefault(),a.style.borderColor="#dee2e6";const t=r.dataTransfer.files;t.length>0&&(o.files=t,w({target:{files:t}}))})),o&&o.addEventListener("change",w);function w(r){const t=r.target.files[0],e=document.getElementById("video-preview"),s=document.getElementById("submit-upload-btn");if(t){n.textContent=t.name;const i=URL.createObjectURL(t);e.src=i,e.style.display="block",e.onloadedmetadata=function(){e.duration>300?(alert("La vidéo ne doit pas dépasser 5 minutes."),o.value="",e.style.display="none",n.textContent="",s.disabled=!0):s.disabled=!1}}else s.disabled=!0}const E=document.getElementById("start-record-btn"),v=document.getElementById("stop-record-btn"),d=document.getElementById("use-video-btn"),p=document.getElementById("live-video"),D=document.getElementById("recorded-video-preview"),b=document.getElementById("recording-timer"),S=document.getElementById("recorded_video_data"),k=document.getElementById("video-placeholder"),L=document.getElementById("submit-record-btn");let c,h=[],B,f=0,g=null;async function C(){const r={browserSupport:!!navigator.mediaDevices&&!!navigator.mediaDevices.getUserMedia,isSecureContext:window.isSecureContext,protocol:window.location.protocol,userAgent:navigator.userAgent,devices:[],videoDevices:[],cameraAccessTest:null,permissionStatus:null};try{if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){const t=await navigator.mediaDevices.enumerateDevices();r.devices=t,r.videoDevices=t.filter(e=>e.kind==="videoinput")}}catch(t){console.error("Erreur lors du diagnostic:",t)}try{if(navigator.permissions){const t=await navigator.permissions.query({name:"camera"});r.permissionStatus=t.state}}catch(t){console.warn("Impossible de vérifier les permissions:",t)}try{const t=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1});r.cameraAccessTest="success",t.getTracks().forEach(e=>e.stop())}catch(t){r.cameraAccessTest=t.name||t.message}return console.log("Diagnostic des caméras:",r),r}if(E){E.addEventListener("click",async()=>{const t=document.getElementById("camera-permission-error");t.style.display="none";try{const e=await C();if(!e.browserSupport)throw new Error("MediaDevices API not supported");if(e.videoDevices.length===0)throw new Error("NoVideoDevicesFound");let s;try{s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0})}catch(i){console.warn("Impossible d'accéder au microphone, essai avec vidéo seulement:",i);try{s=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1})}catch(u){throw console.error("Impossible d'accéder à la caméra:",u),u}}p.srcObject=s,p.style.display="block",k.style.display="none",c=new MediaRecorder(s,{mimeType:"video/webm"}),c.ondataavailable=i=>{i.data.size>0&&h.push(i.data)},c.onstart=()=>{g=null,h=[],E.disabled=!0,v.disabled=!1,b.style.display="block",f=0,b.textContent="0s",B=setInterval(()=>{f++,b.textContent=`${f}s`,f>=60&&v.click()},1e3)},c.onstop=()=>{clearInterval(B),b.style.display="none",g=new Blob(h,{type:"video/webm"});const i=URL.createObjectURL(g);D.src=i,D.style.display="block",d.style.display="block",p.style.display="none",k.style.display="none",p.srcObject.getTracks().forEach(u=>u.stop())},c.start()}catch(e){console.error("Erreur d'accès à la caméra: ",e);let s="<strong>Erreur d'accès à la caméra.</strong> ",i="";switch(e.name||e.message){case"NotFoundError":case"NoVideoDevicesFound":s+="Aucune caméra n'a été trouvée sur votre appareil.",i=`
                            <div class="mt-3">
                                <strong>Solutions possibles :</strong>
                                <ul class="mt-2">
                                    <li>Vérifiez qu'une caméra est bien connectée à votre ordinateur</li>
                                    <li>Si vous utilisez une caméra externe, assurez-vous qu'elle est branchée et allumée</li>
                                    <li>Redémarrez votre navigateur et réessayez</li>
                                    <li>Vérifiez les pilotes de votre caméra dans le gestionnaire de périphériques</li>
                                    <li>Essayez avec un autre navigateur (Chrome, Firefox, Safari)</li>
                                </ul>
                            </div>`;break;case"NotAllowedError":s+="L'accès à la caméra a été refusé. Veuillez l'autoriser dans les paramètres de votre navigateur.",i=`
                            <div class="mt-3">
                                <strong>Comment autoriser la caméra :</strong>
                                <ul class="mt-2">
                                    <li>Cliquez sur l'icône de caméra dans la barre d'adresse</li>
                                    <li>Sélectionnez "Autoriser" pour ce site</li>
                                    <li>Rechargez la page et réessayez</li>
                                    <li>Dans Chrome : Paramètres > Confidentialité et sécurité > Paramètres du site > Caméra</li>
                                </ul>
                            </div>`;break;case"NotReadableError":s+="Un problème matériel empêche l'accès à la caméra. Assurez-vous qu'elle n'est pas utilisée par une autre application.",i=`
                            <div class="mt-3">
                                <strong>Solutions possibles :</strong>
                                <ul class="mt-2">
                                    <li>Fermez toutes les autres applications utilisant la caméra (Zoom, Skype, etc.)</li>
                                    <li>Redémarrez votre ordinateur</li>
                                    <li>Vérifiez que la caméra fonctionne dans d'autres applications</li>
                                </ul>
                            </div>`;break;case"MediaDevices API not supported":s+="Votre navigateur ne supporte pas l'accès à la caméra.",i=`
                            <div class="mt-3">
                                <strong>Solutions possibles :</strong>
                                <ul class="mt-2">
                                    <li>Mettez à jour votre navigateur vers la dernière version</li>
                                    <li>Utilisez un navigateur moderne (Chrome, Firefox, Safari, Edge)</li>
                                    <li>Vérifiez que JavaScript est activé</li>
                                </ul>
                            </div>`;break;default:s+="Une erreur inattendue est survenue. Veuillez réessayer.",i=`
                            <div class="mt-3">
                                <strong>Solutions générales :</strong>
                                <ul class="mt-2">
                                    <li>Rechargez la page et réessayez</li>
                                    <li>Redémarrez votre navigateur</li>
                                    <li>Essayez avec un autre navigateur</li>
                                    <li>Vérifiez votre connexion internet</li>
                                </ul>
                            </div>`}t.innerHTML=s+i,t.className="camera-error",t.style.display="block"}});const r=document.getElementById("diagnoseCameras");r&&r.addEventListener("click",async()=>{const t=document.getElementById("camera-permission-error"),e=await C();let s="<strong>Diagnostic des caméras :</strong><br>";if(s+=`<br><strong>Support du navigateur :</strong> ${e.browserSupport?"✅ Supporté":"❌ Non supporté"}`,s+=`<br><strong>Connexion sécurisée :</strong> ${e.isSecureContext?"✅ HTTPS":"⚠️ HTTP"} (${e.protocol})`,e.permissionStatus){const l=e.permissionStatus==="granted"?"✅":e.permissionStatus==="denied"?"❌":"⚠️";s+=`<br><strong>Permission caméra :</strong> ${l} ${e.permissionStatus}`}if(e.cameraAccessTest){const l=e.cameraAccessTest==="success"?"✅":"❌",I=e.cameraAccessTest==="success"?"Accès réussi":e.cameraAccessTest;s+=`<br><strong>Test d'accès :</strong> ${l} ${I}`}const i=e.userAgent.includes("Chrome")?"Chrome":e.userAgent.includes("Firefox")?"Firefox":e.userAgent.includes("Safari")?"Safari":e.userAgent.includes("Edge")?"Edge":"Autre";s+=`<br><strong>Navigateur :</strong> ${i}`,s+=`<br><strong>Caméras détectées :</strong> ${e.videoDevices.length}`,e.videoDevices.length>0?(s+='<ul class="mt-2">',e.videoDevices.forEach((l,I)=>{const A=l.label||`Caméra ${I+1}`;s+=`<li>${A} (ID: ${l.deviceId.substring(0,8)}...)</li>`}),s+="</ul>"):s+='<br><span style="color: #d32f2f;">❌ Aucune caméra détectée</span>';const u=e.devices.filter(l=>l.kind==="audioinput");s+=`<br><strong>Microphones détectés :</strong> ${u.length}`,e.browserSupport?e.videoDevices.length===0?s+=`<br><br><strong style="color: #d32f2f;">⚠️ Aucune caméra n'a été détectée sur votre système.</strong>`:s+=`<br><br><strong style="color: #2e7d32;">✅ Votre système semble compatible avec l'enregistrement vidéo.</strong>`:s+=`<br><br><strong style="color: #d32f2f;">⚠️ Votre navigateur ne supporte pas l'accès aux caméras.</strong>`,t.innerHTML=s,t.className="camera-error diagnostic",t.style.display="block"})}v&&v.addEventListener("click",()=>{c&&c.state==="recording"&&c.stop(),v.disabled=!0}),d&&d.addEventListener("click",()=>{if(g){const r=new FileReader;r.onloadend=function(){const t=r.result;S.value=t,alert("La vidéo enregistrée a été ajoutée au formulaire."),d.disabled=!0,d.innerHTML='<i class="fas fa-check"></i> Vidéo ajoutée',d.style.background="linear-gradient(135deg, #48bb78 0%, #38a169 100%)",L.disabled=!1,o.value="";const e=document.getElementById("video-preview");e.src="",e.style.display="none",n.textContent=""},r.readAsDataURL(g)}});const T=document.querySelector("#record-video form");T&&T.addEventListener("submit",function(r){if(!(S.value.trim()!=="")){alert("Veuillez enregistrer une vidéo avant de soumettre."),r.preventDefault();return}const e=r.submitter;e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Envoi en cours...')});const z=document.querySelector("#upload-video form");z&&z.addEventListener("submit",function(r){if(!(o.files.length>0)){alert("Veuillez sélectionner une vidéo à importer."),r.preventDefault();return}const e=r.submitter;e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Envoi en cours...')})});window.openTab=V;
